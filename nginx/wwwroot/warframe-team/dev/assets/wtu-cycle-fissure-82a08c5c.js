import{e as be,aa as ye,aA as ge,a3 as he,r as f,l as E,a4 as Se,ag as ke,w as Z,ap as we,p as d,F as b,z as n,x as l,y as h,t as u,v as i,A as Ce,G as D,O as j,q as K,Z as y,C as L,ah as J,ay as T,aB as xe,aC as Ee,a7 as Fe,a8 as Ne,a9 as $e}from"./index-69a426b7.js";import{E as Be}from"./el-dialog-d09e0ff6.js";import"./el-overlay-783c7ab8.js";import{E as ze}from"./el-button-26725033.js";import{E as De,b as Ke,a as Le}from"./wtu-focus-1906bb96.js";import{E as Te}from"./el-divider-1e109ec3.js";import{E as Ie,a as Ve}from"./theme-abdce359.js";import{E as He}from"./el-statistic-07ce2fcf.js";import{k as P}from"./index-b99f4544.js";import{f as Ue,u as I}from"./wtu-team-list-c826900e.js";/* empty css                   */import{a as V}from"./index-569d277e.js";const Q=S=>(Fe("data-v-7ee8bb9a"),S=S(),Ne(),S),qe={key:0,class:"text-center color-gray text-size-[0.88em] lt-md:mt-1em"},Ae={key:1,class:"lt-md:mt-1em"},Oe={class:"options"},Re={class:"transform-translate-y-[-2px]"},Ge=["onClick"],Me=["onClick"],We=Q(()=>l("span",null,"订阅管理",-1)),Ze={class:"flex-between"},je=Q(()=>l("div",{class:"i-ep:close"},null,-1)),Je={key:0,class:"mt-1em"},Pe=be({__name:"wtu-cycle-fissure",setup(S){const p=ye(),F={title:"",body:"",dir:"auto",lang:"zh",renotify:!1},{isSupported:X,show:Y}=ge(F),c=he(),r=f([]),ee=E(()=>r.value.length===0),H=f(!0),m=f(!1),_=Se(),g=f(!1),te=()=>{g.value=!g.value},U=f(!0),q=E(()=>new Date().getTime()),A=async t=>{m.value=t,w()},k=ke({visible:!1}),O=E(()=>c.findSubscriptionListByChannel(_.name).sort((t,e)=>e.tierNum-t.tierNum).sort(t=>t.isHard?1:-1)),se=E(()=>O.value.length===0),oe=()=>{k.visible=!0},w=async()=>{if(p.getServer()){const t=await P();let e=R(t.data);r.value=ne(e),m.value&&(r.value=ae(e)),ie(r.value),U.value=!1}else{r.value=[];return}};w();const R=t=>{let e=[];switch(_.name){case"fissure":e=t.filter(s=>s.isHard===p.getDifficulty()&&s.isStorm===!1&&s.expired===!1&&I(s.expiry)>q.value);break;case"empyrean":e=t.filter(s=>s.isStorm===!0&&s.expired===!1&&I(s.expiry)>q.value);break}return e},ne=t=>t.map(e=>(e.subscribed=T(c.findSubscriptionListByChannel(_.name).find(s=>s.missionKey===e.missionKey&&s.nodeKey===e.nodeKey)),e)),ae=t=>t.filter(e=>e.subscribed),ie=t=>{t.sort((e,s)=>e.tierNum-s.tierNum)};Z(()=>p.getServer(),()=>{w()}),Z(()=>p.getDifficulty(),()=>{w()});const le=async()=>{const t=c.getFissureSubs();(await xe(t)).success?V.success("订阅记录已上传"):V.error("订阅记录上传失败")},C=f(!1),N=f(),re=async()=>{C.value=!0;const t=p.getUUID();N.value=c.getFissureSubs();const e=await Ee(t);c.setFissureSubs(e.data)},ce=()=>{C.value=!1,N.value=null,V.success("订阅记录已更新")},ue=()=>{C.value=!1,c.setFissureSubs(N.value)},de=t=>{let e=r.value.findIndex(s=>s.id===t);e!==-1&&(r.value.splice(e,1),c.removeNotifyHistory(t),G())},G=async()=>{const t=await P();let e=R(t.data),s=_e(e,r.value);s.length===0?setTimeout(()=>G(),1e3*3):(m.value||s.forEach(a=>{r.value.map(v=>v.id).includes(a.id)||r.value.unshift(a)}),pe(_.name,s))},pe=(t,e)=>{let s=c.findSubscriptionListByChannel(t);s.length>0&&e.map(a=>{let v=s.find(x=>x.missionKey===a.missionKey&&x.nodeKey===a.nodeKey);a.subscribed=T(v),m.value&&r.value.unshift(a),T(v)&&a.subscribed&&X.value&&!U.value&&!c.hasNotified(a.id)&&(F.title=a.tier+a.missionType+a.node,F.body=_.meta.forehead+" 订阅的虚空裂缝",c.addNotifyHistory(a.id),Y())})},me=t=>{c.removeSubscription(_.name,t.id),t.subscribed=!1},M=t=>{r.value.map(e=>{t.id===e.id&&(e.subscribed=!e.subscribed)}),c.toggleSubscription(_.name,t)};we(()=>{(r.value.length||!p.getServer())&&(H.value=!1)});const _e=(t,e)=>t.filter(s=>!e.map(a=>a.id).includes(s.id));return(t,e)=>{const s=He,a=De,v=Ie,$=Ve,x=Te,W=Ke,ve=Le,B=ze,fe=Be;return d(),b(D,null,[n(p).getServer()===0?(d(),b("div",qe," 国服暂不支持裂缝订阅，若您有想法，可以向我提供技术支持 ")):(d(),b("div",Ae,[l("div",Oe,[l("div",null,[l("span",{class:h(["option",{active:!n(m)}]),onClick:e[0]||(e[0]=o=>A(!1))}," 全部 ",2),l("span",{class:h(["option",{active:n(m)}]),onClick:e[1]||(e[1]=o=>A(!0))}," 订阅 ",2),l("span",{class:h(["option",{active:n(k).visible}]),onClick:e[2]||(e[2]=o=>oe())},"管理",2)]),l("div",{class:h([n(g)?"i-ep:arrow-down-bold":"i-ep:minus","c-p hover-color-blue ml-0.5em"]),onClick:e[3]||(e[3]=o=>te())},null,2)]),u(ve,{loading:n(H),rows:1},{default:i(()=>[u(W,{empty:n(ee),tip:n(m)?"暂无订阅":"请稍等，正在加载..."},{default:i(()=>[u($,{style:Ce({display:n(g)&&"none"})},{default:i(()=>[(d(!0),b(D,null,j(n(r),o=>(d(),K(v,{xs:12,sm:8,md:6,xl:4,class:"p-0.4em"},{default:i(()=>[u(a,{shadow:"hover",class:h(["animate__animated",{animate__fadeIn:!o.expired,animate__fadeOut:o.expired||n(g)}])},{default:i(()=>[u(s,{format:n(Ue).hour,value:n(I)(o.expiry),onFinish:z=>de(o.id)},{title:i(()=>[l("div",null,y(o.tier)+" "+y(o.node),1)]),prefix:i(()=>[l("div",Re,[o.subscribed?(d(),b("span",{key:0,class:"i-ant-design:check-square-outlined c-p color-blue",onClick:z=>M(o)},null,8,Ge)):L("",!0),l("span",{class:"text-size-[0.8em] c-p inline hover-color-blue select-none",onClick:z=>M(o)},y(o.missionType)+"  ",9,Me)])]),_:2},1032,["format","value","onFinish"])]),_:2},1032,["class"])]),_:2},1024))),256))]),_:1},8,["style"]),n(g)?(d(),K(x,{key:0})):L("",!0)]),_:1},8,["empty","tip"])]),_:1},8,["loading"])])),u(fe,{modelValue:n(k).visible,"onUpdate:modelValue":e[6]||(e[6]=o=>n(k).visible=o)},{header:i(()=>[l("div",null,[We,l("span",{class:"i-ep:upload mr-0.5em ml-0.5em c-p hover-color-blue",onClick:e[4]||(e[4]=o=>le())}),l("span",{class:"i-ep:download c-p hover-color-blue",onClick:e[5]||(e[5]=o=>re())})])]),default:i(()=>[u(W,{empty:n(se)},{default:i(()=>[u($,null,{default:i(()=>[(d(!0),b(D,null,j(n(O),o=>(d(),K(v,{span:24,class:"subs"},{default:i(()=>[u(a,{shadow:"hover"},{default:i(()=>[l("div",Ze,[l("div",null,y(o.isHard?"钢铁":"普通")+" - "+y(o.tier)+"  "+y(o.node)+" "+y(o.missionType),1),u(B,{onClick:z=>me(o),size:"small"},{default:i(()=>[je]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024))),256))]),_:1})]),_:1},8,["empty"]),n(C)?(d(),b("div",Je,[u(B,{onClick:ce},{default:i(()=>[J("保存")]),_:1}),u(B,{onClick:ue},{default:i(()=>[J("取消")]),_:1})])):L("",!0)]),_:1},8,["modelValue"])],64)}}});const ct=$e(Pe,[["__scopeId","data-v-7ee8bb9a"]]);export{ct as _};
